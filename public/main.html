<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Glitch</title>
    <link rel="icon" href="/assets/favicon.png" type="image/png" />
    <link rel="stylesheet" href="styles.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
      body {
          margin: 0;
          overflow: hidden;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Modern font */
          /* disable highlihghting */
          user-select: none;
          display: flex; /* Flexbox for layout */
          flex-direction: column; /* Stack elements vertically */
          height: 100vh; /* Full viewport height */
      }

      html {
          overflow: hidden;
      }

      html::-webkit-scrollbar, body::-webkit-scrollbar {
          display: none;
      }

      .window {
          border: 1px solid #4a4a4a;
          position: absolute;
          width: 450px;
          height: 350px;
          box-shadow: 0 1px 5px 0 rgba(100, 100, 100, 0.7), 0 2px 8px 2px rgba(100, 100, 100, 0.4);
          background: #1e1e1e;
          resize: both;
          overflow: auto;
          top: 15vh;
          left: 15vw;
          border-radius: 8px;
          scrollbar-width: thin;
          scrollbar-color: #888 #222;
          -ms-overflow-style: auto;
          padding-bottom: 10px;
          transition: box-shadow 0.2s ease;
      }

      .window:hover {
          box-shadow: 0 1px 8px 0 rgba(130, 130, 130, 0.8), 0 4px 12px 4px rgba(130, 130, 130, 0.5);
      }

      .window::-webkit-scrollbar {
          width: 8px; /* Thin scrollbar for Webkit */
      }

      .window::-webkit-scrollbar-track {
          background-color: #222; /* Darker scrollbar track */
          border-radius: 10px;
      }

      .window::-webkit-scrollbar-thumb {
          background-color: #555; /* Darker scrollbar thumb */
          border-radius: 10px;
      }

      .window-header {
          display: flex;
          justify-content: space-between;
          background: #2a2a2a;
          color: #ccc;
          cursor: move;
          padding: 8px 12px;
          border-top-left-radius: 8px;
          border-top-right-radius: 8px;
          border-bottom: 1px solid #444;
          font-weight: 500;
          font-size: 0.95em;
      }

      .window-title {
          flex-grow: 1;
          font-size: 1em; /* Slightly smaller title */
          font-weight: bold; /* Bold title for better readability */
          color: #bb86fc;
      }

      .btn {
          background: none;
          border: none;
          padding: 5px 8px;
          cursor: pointer;
          color: #aaa;
          font-size: 1em;
          transition: color 0.1s ease;
      }

      .btn:hover {
          color: #ddd;
      }

      .btn.close:hover {
          color: #cf6679;
      }

      .window-content {
          padding: 12px; /* Slightly reduced content padding */
          color: #eee; /* Slightly brighter content text */
          line-height: 1.5; /* Slightly tighter line height */
          font-size: 0.95em; /* Slightly smaller font size */
      }

      .window-content iframe {
          border-radius: 10px; /* Adjust the value to control the roundness */
          overflow: hidden; /* Ensure content within rounded corners is clipped */
      }

      .toolbar {
          display: flex;
          align-items: center;
          justify-content: space-between;
          height: 60px; /* Slightly taller toolbar */
          background-color: rgba(255, 255, 255, 0.15); /* Slightly less transparent */
          background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0.08), transparent); /* More subtle gradient */
          color: #fff;
          padding: 0 15px;
          position: fixed;
          bottom: 0;
          user-select: none;
          z-index: 10000;
          width: calc(98% + 10px);
          border-top-left-radius: 20px;
          border-top-right-radius: 20px;
          border-top: 1px solid rgba(255, 255, 255, 0.15); /* More visible border */
          backdrop-filter: blur(10px); /* Apply blur to background */
      }

      .start-menu.material-symbols-outlined {
          font-size: 30px; /* Larger icons */
          cursor: pointer;
          transition: transform 0.2s ease; /* Smooth icon animation */
      }

      .start-menu.material-symbols-outlined:hover {
          transform: scale(1.1); /* Slight zoom on hover */
      }

      .pinned-apps {
          display: flex;
          gap: 12px; /* Larger gap */
      }

      .pinned-apps span.material-symbols-outlined {
          background-color: rgba(255, 255, 255, 0.1);
          border-radius: 50%;
          padding: 8px;
      }

      .pinned-apps.material-symbols-outlined {
          font-size: 30px;
          cursor: pointer;
          transition: transform 0.2s ease;
      }

      .pinned-apps.material-symbols-outlined:hover {
          transform: scale(1.1);
      }

      .system-tray {
          display: flex;
          align-items: center;
          gap: 10px; /* Larger gap */
      }

      .system-tray.material-symbols-outlined {
          font-size: 22px; /* Slightly larger icons */
          cursor: pointer;
      }

      .time {
          font-size: 18px; /* Larger font size */
          position: fixed;
          right: 20px;
          color: #fff;
          font-weight: 500; /* Slightly bolder */
      }

      .pinned-apps input {
          background-color: rgba(255, 255, 255, 0.1); /* Slightly transparent white background */
          border: none; /* Remove default border */
          border-radius: 15px; /* Rounded corners */
          padding: 8px 12px; /* Padding for comfortable text input */
          color: white; /* White text color */
          font-size: 16px; /* Readable font size */
          flex-grow: 1; /* Allow input to grow and take available space */
          min-width: 100px; /* Minimum width to prevent collapsing */
      }

      .pinned-apps input::placeholder {
          color: rgba(255, 255, 255, 0.5); /* Semi-transparent placeholder text */
      }

      #search_suggestions {
          position: absolute;
          top: 100%;
          left: 50%; /* Center horizontally */
          transform: translateX(-50%); /* Adjust for element's width */
          width: 100%; /* Match input width */
          background-color: #1e1e1e; /* Slightly lighter than toolbar */
          color: white;
          border-radius: 0 0 15px 15px; /* Rounded bottom corners */
          padding: 10px;
          z-index: 100; /* Ensure it's above other elements */
          box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); /* Subtle shadow */
          display: none; /* Initially hide the suggestions */
      }

      #search_suggestions ul {
          list-style: none; /* Remove bullet points */
          padding: 0;
          margin: 0;
      }

      #search_suggestions li {
          padding: 8px 12px;
          cursor: pointer;
      }

      #search_suggestions li:hover {
          background-color: #3a3a3a; /* Hover effect */
      }

      /* Style for the window - adjust selector if needed */
      .window {
        overflow: hidden;
      }

      /* Remove rounding when maximized for window */
      .window.maximized-no-round {
        border-radius: 0;
      }

      /* Remove top left-right rounding when maximized for toolbar */
      .toolbar.maximized-no-round {
        border-top-left-radius: 0;
        border-top-right-radius: 0;
      }

      .snap-preview-box {
          position: fixed;
          top: 0;
          height: calc(100vh - 60px); /* Full height minus toolbar */
          width: 50vw;
          background-color: rgba(145, 61, 194, 0.3); /* Semi-transparent purple */
          border: 2px dashed #913dc2;
          pointer-events: none; /* Ignore mouse events */
          z-index: 9999;
          transition: opacity 0.2s ease;
          opacity: 0;
      }
      .snap-preview-box.visible {
          opacity: 1;
      }
      .snap-preview-left {
          left: 0;
      }
      .snap-preview-right {
          right: 0;
      }

      @keyframes empty_trash {
        /* wobble effect */

        0% {
          transform: rotate(0deg);
        }
        25% {
          transform: rotate(10deg);
        }
        50% {
          transform: rotate(0deg);
        }
        75% {
          transform: rotate(-10deg);
        }
        100% {
          transform: rotate(0deg);
        }
      }
    </style>
</head>
<body>
  <div id="search_suggestions">

  </div>
    <div class="toolbar">
        <div class="start-menu" onclick="openApp('dash')">
            <span class="material-symbols-outlined">circle</span>
        </div>
        <div class="pinned-apps">
            <input placeholder="Search" id="searchInput" />
            <span class="material-symbols-outlined" onclick="openApp('fileexplorer')" title="File Explorer">folder</span>
            <span class="material-symbols-outlined" onclick="openApp('terminal')">terminal</span>
            <span class="material-symbols-outlined" onclick="openApp('web')">public</span>
            <span class="material-symbols-outlined" onclick="openApp('game')">sports_esports</span>
            <span class="material-symbols-outlined" onclick="openApp('gpt')">robot</span>
            <span class="material-symbols-outlined" onclick="openApp('chat')">chat</span>
            <span class="material-symbols-outlined" onclick="openApp('miniplayer')">play_circle</span>
<span class="material-symbols-outlined" onclick="openApp('settings')" title="Settings">settings</span>
        </div>
        <div class="system-tray">
            <div id="clock" class="time"></div>
        </div>
    </div>
    <script defer>

      // time
      function updateClock() {
          const now = new Date();
          const hours = now.getHours();
          const minutes = now.getMinutes();
          const seconds = now.getSeconds();
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const formattedHours = hours % 12 || 12;
          const formattedMinutes = minutes.toString().padStart(2, '0');
          const timeString = `${formattedHours}:${formattedMinutes} ${ampm}`;
          document.getElementById('clock').textContent = timeString;
      }

      updateClock();

      setInterval(updateClock, 1000);

      function openApp(name) {
          if (name === 'fileexplorer') {
              //public\fileexplorer.html
              createWindow(Math.random().toString(36).substring(2, 15), 'File Explorer', '<iframe src="fileexplorer.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'dash') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Dashboard', '<iframe src="features/dashboard.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'terminal') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Terminal', '<iframe src="features/terminal.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'web') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Web', '<iframe src="launch.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'game') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Games', '<iframe src="games.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'gpt') {
              createWindow(Math.random().toString(36).substring(2, 15), 'GPT', '<iframe src="features/gpt.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          if (name === 'chat') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Chat', '<iframe src="chat.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              //createWindow(Math.random().toString(36).substring(2, 15), 'Discord', '<iframe src="https://e.widgetbot.io/channels/1200803518802571334/1203397751820390417s" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
           }
          if (name === 'miniplayer') {
              createWindow(Math.random().toString(36).substring(2, 15), 'Mini Player', '<iframe src="features/miniplayer.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              return;
          }
          console.log(`App '${name}' is not implemented.`);
      }

      let zIndexCounter = 1000; // Start with a high z-index value
      
      function createWindow(id, title, content) {
          const windowElement = document.createElement('div');
          windowElement.className = 'window';
          windowElement.id = id;
          windowElement.style.zIndex = ++zIndexCounter;
      
          const header = document.createElement('div');
          header.className = 'window-header';
          const titleElement = document.createElement('span');
          titleElement.textContent = title;
          titleElement.className = 'window-title';
          header.appendChild(titleElement);
      
          const minimizeBtn = document.createElement('button');
          minimizeBtn.textContent = '_';
          minimizeBtn.className = 'btn minimize';
          header.appendChild(minimizeBtn);
      
          const maximizeBtn = document.createElement('button');
          maximizeBtn.textContent = '□';
          maximizeBtn.className = 'btn maximize';
          header.appendChild(maximizeBtn);
      
          const closeBtn = document.createElement('button');
          closeBtn.textContent = '×';
          closeBtn.className = 'btn close';
          header.appendChild(closeBtn);
      
          windowElement.appendChild(header);
      
          const contentElement = document.createElement('div');
          contentElement.className = 'window-content';
          contentElement.style.height = 'calc(100% - 30px)'; // Adjust height to take into account header height
          contentElement.innerHTML = content;
          windowElement.appendChild(contentElement);
      
          document.body.appendChild(windowElement);
      
          addWindowFunctionality(windowElement, header);
          return windowElement;
      }
      
      document.getElementById('searchInput').addEventListener('keypress', function(event) {
          if (event.key === 'Enter') {
              const searchQuery = this.value;
              const url = 'launch.html?url=' + encodeURIComponent(searchQuery);
              createWindow(Math.random().toString(36).substring(2, 15), 'Tabs', `<iframe src="${url}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`);
          }
      });
      
      function addWindowFunctionality(windowElement, header) {
          let isDragging = false, offsetX, offsetY;
          let originalWidth, originalHeight, originalLeft, originalTop;
          // Only create one snapPreviewBox globally
          let snapPreviewBox = document.querySelector('.snap-preview-box');
          if (!snapPreviewBox) {
              snapPreviewBox = document.createElement('div');
              snapPreviewBox.className = 'snap-preview-box';
              // Ensure correct dimensions (in case CSS is overridden)
              snapPreviewBox.style.position = 'fixed';
              snapPreviewBox.style.top = '0';
              snapPreviewBox.style.height = 'calc(100vh - 60px)';
              snapPreviewBox.style.width = '50vw';
              snapPreviewBox.style.pointerEvents = 'none';
              document.body.appendChild(snapPreviewBox);
          }
      
          header.onmousedown = function(event) {

              // Prevent drag/auto-minimize logic if clicking a header button
              if (event.target.closest('.btn')) return;

              // If maximized, restore before dragging
              if (windowElement.classList.contains('maximized')) {
                  windowElement.classList.remove('maximized', 'maximized-no-round');
                  windowElement.classList.remove('snapped-left', 'snapped-right');
                  windowElement.style.width = windowElement.dataset.preMaximizeWidth || '400px';
                  windowElement.style.height = windowElement.dataset.preMaximizeHeight || '300px';
                  windowElement.style.left = windowElement.dataset.preMaximizeLeft || '100px';
                  windowElement.style.top = windowElement.dataset.preMaximizeTop || '100px';
              }

              isDragging = true;
              offsetX = event.clientX - windowElement.offsetLeft;
              offsetY = event.clientY - windowElement.offsetTop;
      
              if (!windowElement.classList.contains('snapped-left') && !windowElement.classList.contains('snapped-right')) {
                  originalWidth = windowElement.style.width;
                  originalHeight = windowElement.style.height;
                  originalLeft = windowElement.style.left;
                  originalTop = windowElement.style.top;
              }
      
              document.onmousemove = function(event) {
                  if (!isDragging) return;

                  // Clamp window position to viewport borders
                  const toolbarHeight = 60;
                  const winWidth = windowElement.offsetWidth;
                  const winHeight = windowElement.offsetHeight;
                  let x = event.clientX - offsetX;
                  let y = event.clientY - offsetY;

                  // Clamp X and Y so window stays inside viewport
                  x = Math.max(0, Math.min(x, window.innerWidth - winWidth));
                  y = Math.max(0, Math.min(y, window.innerHeight - toolbarHeight - winHeight));

                  windowElement.style.left = `${x}px`;
                  windowElement.style.top = `${y}px`;
      
                  const nearLeft = event.clientX < 50;
                  const nearRight = event.clientX > window.innerWidth - 50;
      
                  snapPreviewBox.classList.remove('visible', 'snap-preview-left', 'snap-preview-right');
                  
                  if (nearLeft) {
                      snapPreviewBox.classList.add('visible', 'snap-preview-left');
                  } else if (nearRight) {
                      snapPreviewBox.classList.add('visible', 'snap-preview-right');
                  }
              };
      
              document.onmouseup = function(event) {
                  isDragging = false;
                  snapPreviewBox.classList.remove('visible', 'snap-preview-left', 'snap-preview-right');
      
                  const nearLeft = event.clientX < 50;
                  const nearRight = event.clientX > window.innerWidth - 50;
      
                  if (nearLeft) {
                      windowElement.style.left = '0';
                      windowElement.style.width = '50vw';
                      windowElement.style.top = '0';
                      windowElement.style.height = 'calc(100vh - 60px)';
                      windowElement.classList.add('snapped-left');
                      windowElement.classList.remove('snapped-right', 'maximized', 'maximized-no-round');
                  } else if (nearRight) {
                      windowElement.style.left = '50vw';
                      windowElement.style.width = '50vw';
                      windowElement.style.top = '0';
                      windowElement.style.height = 'calc(100vh - 60px)';
                      windowElement.classList.add('snapped-right');
                      windowElement.classList.remove('snapped-left', 'maximized', 'maximized-no-round');
                  } else if (windowElement.classList.contains('snapped-left') || windowElement.classList.contains('snapped-right')) {
                      windowElement.classList.remove('snapped-left', 'snapped-right');
                      windowElement.style.width = originalWidth;
                      windowElement.style.height = originalHeight;
                      windowElement.style.left = originalLeft;
                      windowElement.style.top = originalTop;
                  }
      
                  document.onmousemove = document.onmouseup = null;
              };
          };
      
          windowElement.querySelector('.minimize').onclick = function() {
              const content = windowElement.querySelector('.window-content');
              // Store current size/position before minimizing
              if (content.style.display !== 'none') {
                  windowElement.dataset.originalWidth = windowElement.style.width;
                  windowElement.dataset.originalHeight = windowElement.style.height;
                  windowElement.dataset.originalLeft = windowElement.style.left;
                  windowElement.dataset.originalTop = windowElement.style.top;
              }
              windowElement.style.height = content.style.display === 'none' ? (windowElement.dataset.originalHeight || '300px') : '30px';
              windowElement.style.width = content.style.display === 'none' ? (windowElement.dataset.originalWidth || '400px') : windowElement.style.width; // Keep width on minimize
              content.style.display = content.style.display === 'none' ? 'block' : 'none';
              // Restore position on unminimize
              if (content.style.display !== 'none') {
                   windowElement.style.left = windowElement.dataset.originalLeft || '100px';
                   windowElement.style.top = windowElement.dataset.originalTop || '100px';
              }
          };
      
          windowElement.querySelector('.maximize').onclick = function() {
              if (windowElement.classList.contains('maximized')) {
                  windowElement.classList.remove('maximized');
                  windowElement.classList.remove('maximized-no-round'); // Remove class for no rounding
                  windowElement.classList.remove('snapped-left', 'snapped-right'); // Remove snapped classes
                  // Restore original size and position (from before maximize)
                  windowElement.style.width = windowElement.dataset.preMaximizeWidth || '400px';
                  windowElement.style.height = windowElement.dataset.preMaximizeHeight || '300px';
                  windowElement.style.left = windowElement.dataset.preMaximizeLeft || '100px';
                  windowElement.style.top = windowElement.dataset.preMaximizeTop || '100px';
              } else {
                  // Store current size and position before maximizing
                  windowElement.dataset.preMaximizeWidth = windowElement.style.width;
                  windowElement.dataset.preMaximizeHeight = windowElement.style.height;
                  windowElement.dataset.preMaximizeLeft = windowElement.style.left;
                  windowElement.dataset.preMaximizeTop = windowElement.style.top;
      
                  windowElement.classList.add('maximized');
                  windowElement.classList.add('maximized-no-round'); // Add class for no rounding
                  windowElement.classList.remove('snapped-left', 'snapped-right'); // Remove snapped classes
                  windowElement.style.width = '100vw';
                  windowElement.style.height = 'calc(100vh - 60px)'; // Full height minus toolbar
                  windowElement.style.left = '0';
                  windowElement.style.top = '0';
              }
          };
      
          windowElement.querySelector('.close').onclick = function() {
              document.body.removeChild(windowElement);
          };
      }
      window.openApp = function(app) {
          // Helper to append ?vm=1 if in VM
          function appendVMParam(url) {
              if (window.isInVM) {
                  if (url.indexOf('?') === -1) {
                      return url + '?vm=1';
                  } else {
                      return url + '&vm=1';
                  }
              }
              return url;
          }

          if (app == "game") {
              createWindow(Math.random().toString(36).substring(2, 15), "Games", `<iframe src="${appendVMParam('apps.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "web") {
              createWindow(Math.random().toString(36).substring(2, 15), "Tabs", `<iframe src="${appendVMParam('launch.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "discord") {
            createWindow(Math.random().toString(36).substring(2, 15), 'Chat', '<iframe src="chat.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              
          } else if (app == "terminal") {
              createWindow(Math.random().toString(36).substring(2, 15), "Terminal", `<iframe src="${appendVMParam('/features/terminal.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "dash") {
              createWindow(Math.random().toString(36).substring(2, 15), "Dashboard", `<iframe src="${appendVMParam('/features/dashboard.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "settings") {
              createWindow(Math.random().toString(36).substring(2, 15), "Settings", `<iframe src="${appendVMParam('/settings.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "gpt") {
              createWindow(Math.random().toString(36).substring(2, 15), "AI Chat", `<iframe src="${appendVMParam('/launch_page.html?url=https://r1web.com/')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "tv") {
          } else if (app == "miniplayer") {
              let url = prompt('Enter YouTube URL:');
              if (url) {
                  const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|embed)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
                  const match = url.match(regex);
                  videoId = null;
                  if (match) {
                       videoId = match[1];
                  }
                  else{
                      alert('Invalid YouTube URL.');
                      return
                  }
                  if (videoId) {
                      const embedUrl = `https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1`;
                      createWindow(
                          Math.random().toString(36).substring(2, 15),
                          'Mini-Player',
                          `<iframe src="${embedUrl}" style="border:0; flex-grow:1; width:100%; height:100%;" allow="autoplay; encrypted-media" allowfullscreen></iframe>`,
                          true
                      );
                  } else {
                      alert('Invalid YouTube URL.');
                  }
              }
          } else if (app == "swiftlytv") {
              createWindow(Math.random().toString(36).substring(2, 15), "Swiftly TV", `<iframe src="${appendVMParam('/launch_page.html?url=https://swifly.cloud/movies.html')}" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>`, true);
          } else if (app == "chat") {
            createWindow(Math.random().toString(36).substring(2, 15), 'Chat', '<iframe src="chat.html" style="border:0; flex-grow:1; width:100%; height:100%;"></iframe>');
              
          }
          else if (app == "fileexplorer") {
            // Create a window and inject the explorer app into a shadow DOM
            const win = createWindow(
              Math.random().toString(36).substring(2, 15),
              "File Explorer",
              `<div id="fileexplorer-app-root" style="width:100%;height:100%;display:flex;flex-direction:column"></div>`
            );
            // Use module script for shadow DOM encapsulation
            (async () => {
              // Wait for DOM
              await new Promise(res => setTimeout(res, 10));
              const root = win.querySelector("#fileexplorer-app-root");
              if (!root) return;
              // Attach shadow root for style encapsulation
              const shadow = root.attachShadow({mode: "open"});
              // Inline CSS for Windows-like file explorer (from fileExplorer.html)
              shadow.innerHTML = `
                <style>
                  :host {
                    --bg-primary: #121212;
                    --bg-secondary: #1e1e1e;
                    --text-primary: #fff;
                    --text-secondary: #b0b0b0;
                    --accent: #bb86fc;
                    --border-radius: 12px;
                    --transition: 0.3s cubic-bezier(.4,0,.2,1);
                  }
                  body, :host { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
                  .toolbar {
                    background: var(--bg-secondary);
                    border-bottom: 1px solid rgba(255,255,255,0.06);
                    padding: 8px 14px;
                    display: flex;
                    gap: 10px;
                    align-items: center;
                    height: 42px;
                    border-top-left-radius: var(--border-radius);
                    border-top-right-radius: var(--border-radius);
                    box-shadow: 0 1px 8px 0 rgba(0,0,0,0.12);
                  }
                  .explorer-container {
                    display: flex;
                    flex: 1 1 auto;
                    min-height: 0;
                    min-width: 0;
                    height: 100%;
                    background: var(--bg-primary);
                    border-bottom-left-radius: var(--border-radius);
                    border-bottom-right-radius: var(--border-radius);
                  }
                  .sidebar {
                    width: 170px;
                    background: var(--bg-secondary);
                    border-right: 1px solid rgba(255,255,255,0.08);
                    padding: 10px 0;
                    overflow-y: auto;
                    height: 100%;
                    color: var(--text-secondary);
                  }
                  .main-panel {
                    flex: 1 1 auto;
                    background: var(--bg-primary);
                    padding: 0;
                    overflow: auto;
                    height: 100%;
                    display: flex;
                    flex-direction: column;
                  }
                  .path-bar {
                    background: var(--bg-secondary);
                    border-bottom: 1px solid rgba(255,255,255,0.08);
                    padding: 9px 16px;
                    font-size: 15px;
                    color: var(--accent);
                    white-space: nowrap;
                    overflow-x: auto;
                    font-weight: 500;
                    letter-spacing: 0.01em;
                  }
                  .file-list {
                    list-style: none;
                    margin: 0;
                    padding: 0;
                    flex: 1 1 auto;
                  }
                  .file-item {
                    display: flex;
                    align-items: center;
                    padding: 10px 22px;
                    cursor: pointer;
                    border-bottom: 1px solid rgba(255,255,255,0.04);
                    transition: background var(--transition);
                    gap: 12px;
                    font-size: 1rem;
                    color: var(--text-primary);
                    border-radius: 7px;
                  }
                  .file-item:hover, .file-item.selected {
                    background: rgba(187,134,252,0.10);
                    color: var(--accent);
                  }
                  .file-icon {
                    width: 22px;
                    text-align: center;
                    font-size: 1.2em;
                  }
                  .folder-tree {
                    list-style: none;
                    padding-left: 15px;
                    margin: 0;
                    font-size: 15px;
                  }
                  .tree-folder {
                    cursor: pointer;
                    padding: 4px 0;
                    display: flex;
                    align-items: center;
                    gap: 7px;
                    user-select: none;
                    border-radius: 7px;
                    transition: background var(--transition);
                  }
                  .tree-folder.selected {
                    background: rgba(187,134,252,0.10);
                    color: var(--accent);
                  }
                  .tree-toggle {
                    font-size: 12px;
                    width: 17px;
                    display: inline-block;
                    color: var(--accent);
                    cursor: pointer;
                    text-align: center;
                  }
                  .tree-toggle.invisible {
                    visibility: hidden;
                  }
                  .tree-icon {
                    width: 19px;
                    text-align: center;
                  }
                  .input-inline {
                    border: 1px solid rgba(255,255,255,0.15);
                    font-size: 15px;
                    padding: 2px 6px;
                    border-radius: 5px;
                    width: 120px;
                    margin-right: 6px;
                    background: var(--bg-primary);
                    color: var(--text-primary);
                  }
                  .btn {
                    padding: 4px 12px;
                    border: none;
                    background: var(--accent);
                    color: #fff;
                    border-radius: 6px;
                    font-size: 15px;
                    cursor: pointer;
                    font-weight: 500;
                    transition: background var(--transition), box-shadow var(--transition);
                    box-shadow: 0 1px 4px 0 rgba(187,134,252,0.09);
                  }
                  .btn:active, .btn:focus {
                    background: #a06bf7;
                    outline: none;
                  }
                  .btn[disabled] {
                    opacity: 0.5;
                    cursor: not-allowed;
                  }
                  @media (max-width: 700px) {
                    .sidebar { display: none; }
                    .main-panel { padding: 0 0 0 0; }
                  }
                </style>
                <div class="toolbar">
                  <button class="btn" id="btn-up"><span class="material-symbols-outlined">arrow_upward</span> Up</button>
                  <button class="btn" id="btn-new-folder"><span class="material-symbols-outlined">create_new_folder</span> New Folder</button>
                  <button class="btn" id="btn-new-file"><span class="material-symbols-outlined">description</span> New File</button>
                  <button class="btn" id="btn-delete" disabled><span class="material-symbols-outlined">delete</span> Delete</button>
                  <span style="flex:1"></span>
                  <span style="font-size:12px;color:#aaa">Glitch File Explorer</span>
                </div>
                <div class="explorer-container">
                  <div class="sidebar" id="sidebar"></div>
                  <div class="main-panel">
                    <div class="path-bar" id="path-bar"></div>
                    <ul class="file-list" id="file-list"></ul>
                  </div>
                </div>
              `;
              // Dynamically import the filesystem module
              const fsmod = await import("./scripts/js/filesystem.js");
              // File explorer logic (scoped to shadow DOM)
              // Windows path helpers
              function splitEntries(lsResult) {
                if (typeof lsResult !== 'string') return [];
                if (lsResult.startsWith("ls:")) return [];
                return lsResult.split(/[\r\n]+/).filter(Boolean);
              }
              function isDir(entry) { return entry.endsWith("\\"); }
              function parentPath(path) {
                path = path.replace(/\//g, '\\').replace(/\\\\+/g, '\\').replace(/^\s+|\s+$/g, '');
                if (path.endsWith('\\')) path = path.slice(0, -1);
                if (path.length <= 3) return path; // C:\
                let idx = path.lastIndexOf('\\');
                if (idx <= 2) return path.slice(0, idx+1);
                return path.slice(0, idx+1);
              }
              function joinPath(base, entry) {
                return (base.endsWith("\\") ? base : base + "\\") + entry.replace(/\\$/, "");
              }
              function getDriveRoots() { return ["C:\\"]; }
              // UI State
              let currentPath = "C:\\";
              let selectedItem = null;
              let expandedDirs = new Set(["C:\\"]);
              // UI Elements
              const sidebar = shadow.getElementById("sidebar");
              const pathBar = shadow.getElementById("path-bar");
              const fileList = shadow.getElementById("file-list");
              const btnUp = shadow.getElementById("btn-up");
              const btnNewFolder = shadow.getElementById("btn-new-folder");
              const btnNewFile = shadow.getElementById("btn-new-file");
              const btnDelete = shadow.getElementById("btn-delete");
              // Render Functions
              function renderPathBar() { pathBar.textContent = currentPath; }
              function renderFileList() {
                fileList.innerHTML = "";
                let entries = splitEntries(fsmod.ls(currentPath));
                entries.sort((a, b) => isDir(b) - isDir(a) || a.localeCompare(b));
                entries.forEach(entry => {
                  let li = document.createElement("li");
                  li.className = "file-item";
                  li.tabIndex = 0;
                  if (selectedItem === entry) li.classList.add("selected");
                  li.dataset.entry = entry;
                  let icon = document.createElement("span");
                  icon.className = "file-icon";
                  icon.textContent = isDir(entry) ? "📁" : "📄";
                  li.appendChild(icon);
                  let label = document.createElement("span");
                  label.textContent = entry.replace(/\\$/, "");
                  li.appendChild(label);
                  li.addEventListener("click", e => {
                    selectedItem = entry;
                    renderFileList();
                    btnDelete.disabled = false;
                  });
                  li.addEventListener("dblclick", e => {
                    if (isDir(entry)) {
                      currentPath = joinPath(currentPath, entry);
                      selectedItem = null;
                      renderAll();
                    }
                  });
                  fileList.appendChild(li);
                });
                if (!entries.length) {
                  let li = document.createElement("li");
                  li.className = "file-item";
                  li.style.color = "#aaa";
                  li.textContent = "(empty)";
                  fileList.appendChild(li);
                }
              }
              function renderSidebar() {
                sidebar.innerHTML = "";
                let tree = document.createElement("ul");
                tree.className = "folder-tree";
                getDriveRoots().forEach(drive => {
                  let node = createTreeNode(drive, drive, 0);
                  tree.appendChild(node);
                });
                sidebar.appendChild(tree);
              }
              function createTreeNode(label, path, depth) {
                let li = document.createElement("li");
                let row = document.createElement("div");
                row.className = "tree-folder";
                if (path === currentPath) row.classList.add("selected");
                let toggle = document.createElement("span");
                toggle.className = "tree-toggle";
                let subEntries = splitEntries(fsmod.ls(path)).filter(isDir);
                if (subEntries.length > 0) {
                  toggle.textContent = expandedDirs.has(path) ? "▼" : "►";
                  toggle.onclick = e => {
                    e.stopPropagation();
                    if (expandedDirs.has(path)) expandedDirs.delete(path);
                    else expandedDirs.add(path);
                    renderSidebar();
                  };
                } else {
                  toggle.textContent = "";
                  toggle.classList.add("invisible");
                }
                let icon = document.createElement("span");
                icon.className = "tree-icon";
                icon.textContent = "📁";
                let name = document.createElement("span");
                name.textContent = label.replace(/\\$/, "");
                row.appendChild(toggle);
                row.appendChild(icon);
                row.appendChild(name);
                row.onclick = e => {
                  currentPath = path;
                  selectedItem = null;
                  renderAll();
                };
                li.appendChild(row);
                if (expandedDirs.has(path) && subEntries.length > 0) {
                  let ul = document.createElement("ul");
                  ul.className = "folder-tree";
                  subEntries.forEach(subdir => {
                    let subPath = joinPath(path, subdir);
                    ul.appendChild(createTreeNode(subdir, subPath, depth + 1));
                  });
                  li.appendChild(ul);
                }
                return li;
              }
              function renderAll() {
                renderPathBar();
                renderFileList();
                renderSidebar();
                btnDelete.disabled = !selectedItem;
              }
              // Toolbar Actions
              btnUp.onclick = () => {
                if (currentPath === "C:\\") return;
                currentPath = parentPath(currentPath);
                selectedItem = null;
                renderAll();
              };
              btnNewFolder.onclick = () => {
                let folderName = prompt("New folder name:");
                if (!folderName) return;
                let msg = fsmod.mkdir(currentPath, folderName);
                renderAll();
                alert(msg);
              };
              btnNewFile.onclick = () => {
                let fileName = prompt("New file name:");
                if (!fileName) return;
                let msg = fsmod.touch(currentPath, fileName);
                renderAll();
                alert(msg);
              };
              btnDelete.onclick = () => {
                if (!selectedItem) return;
                let confirmMsg = `Are you sure you want to delete '${selectedItem.replace(/\\$/, "")}'?`;
                if (!confirm(confirmMsg)) return;
                let msg = fsmod.deleteItem(currentPath, selectedItem.replace(/\\$/, ""));
                selectedItem = null;
                renderAll();
                alert(msg);
              };
              // Keyboard navigation
              fileList.addEventListener("keydown", function(e) {
                let entries = Array.from(fileList.querySelectorAll(".file-item")).filter(li => !li.style.color);
                let idx = entries.findIndex(li => li.classList.contains("selected"));
                if (e.key === "ArrowDown") {
                  if (idx < entries.length - 1) {
                    selectedItem = entries[idx + 1].dataset.entry;
                    renderFileList();
                  }
                  e.preventDefault();
                }
                if (e.key === "ArrowUp") {
                  if (idx > 0) {
                    selectedItem = entries[idx - 1].dataset.entry;
                    renderFileList();
                  }
                  e.preventDefault();
                }
                if (e.key === "Enter" && idx >= 0) {
                  let entry = entries[idx].dataset.entry;
                  if (isDir(entry)) {
                    currentPath = joinPath(currentPath, entry);
                    selectedItem = null;
                    renderAll();
                  }
                }
                if (e.key === "Delete" && idx >= 0) {
                  btnDelete.onclick();
                }
              });
              // Initial render
              renderAll();
            })();
          }
      };
    </script>

    <style>
    #selectionBox {
        position: fixed;
        border: 2px dashed #4a90e2;
        background-color: rgba(74, 144, 226, 0.2);
        pointer-events: none;
        display: none;
        z-index: 25000;
        border-radius: 4px;
    }
    </style>

    <div id="selectionBox"></div>

    <script>
    (function() {
        const selectionBox = document.getElementById('selectionBox');
        let startX, startY, currentX, currentY;
        let isSelecting = false;

        function updateSelectionBox() {
            const x = Math.min(startX, currentX);
            const y = Math.min(startY, currentY);
            const width = Math.abs(startX - currentX);
            const height = Math.abs(startY - currentY);
            selectionBox.style.left = x + 'px';
            selectionBox.style.top = y + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
        }

        document.addEventListener('mousedown', function(e) {
            // Only start selection if left mouse button
            if (e.button !== 0) return;
            isSelecting = true;
            startX = e.clientX;
            startY = e.clientY;
            currentX = startX;
            currentY = startY;
            updateSelectionBox();
            selectionBox.style.display = 'block';

            // Clear previous selection on new selection start
            clearSelectedItems();
        });

        // Track selected items
        const selectedItems = new Set();

        function clearSelectedItems() {
            selectedItems.forEach(item => item.classList.remove('selected'));
            selectedItems.clear();
        }

        function selectItem(item) {
            if (!selectedItems.has(item)) {
                selectedItems.add(item);
                item.classList.add('selected');
            }
        }

        function updateSelection() {
            clearSelectedItems();
            const rect = selectionBox.getBoundingClientRect();
            const items = document.querySelectorAll('.desktop-item');
            items.forEach(item => {
                const itemRect = item.getBoundingClientRect();
                if (
                    itemRect.left < rect.right &&
                    itemRect.right > rect.left &&
                    itemRect.top < rect.bottom &&
                    itemRect.bottom > rect.top
                ) {
                    selectItem(item);
                }
            });
        }
        
        document.addEventListener('mousemove', function(e) {
            if (!isSelecting) return;
            currentX = e.clientX;
            currentY = e.clientY;
            updateSelectionBox();
            updateSelection();
        });
        
        document.addEventListener('mouseup', function(e) {
            if (!isSelecting) return;
            isSelecting = false;
            selectionBox.style.display = 'none';
            // Selection finalized
        });
        
        // Make selected items draggable as a group
        function setupDragForSelectedItems() {
            selectedItems.forEach(item => {
                item.setAttribute('draggable', 'true');
                item.addEventListener('dragstart', dragStartHandler);
                item.addEventListener('dragend', dragEndHandler);
            });
        }
        
        function clearDragHandlers() {
            selectedItems.forEach(item => {
                item.removeAttribute('draggable');
                item.removeEventListener('dragstart', dragStartHandler);
                item.removeEventListener('dragend', dragEndHandler);
            });
        }
        
        function dragStartHandler(e) {
            const draggedItems = Array.from(selectedItems).map(item => {
                return {
                    name: item.getAttribute('data-name'),
                    isFolder: item.getAttribute('data-isfolder') === 'true'
                };
            });
            e.dataTransfer.setData('application/json', JSON.stringify(draggedItems));
            e.dataTransfer.effectAllowed = 'move';
        }
        
        function dragEndHandler(e) {
            clearDragHandlers();
        }
        
        // Setup drag on click or other event on desktop items
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('desktop-item')) {
                if (!e.shiftKey && !e.ctrlKey) {
                    clearSelectedItems();
                }
                selectItem(e.target);
                clearDragHandlers();
                setupDragForSelectedItems();
            }
        });
    })();
    </script>

    <style>
    #customContextMenu {
        position: fixed;
        background: #2a2a2a;
        border: 1px solid #555;
        border-radius: 6px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        color: #eee;
        width: 180px;
        display: none;
        z-index: 20000;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    #customContextMenu ul {
        list-style: none;
        margin: 0;
        padding: 8px 0;
    }
    #customContextMenu li {
        padding: 8px 16px;
        cursor: pointer;
        user-select: none;
    }
    #customContextMenu li:hover {
        background-color: #444;
    }
    </style>

    <div id="customContextMenu">
        <ul>
            <li data-action="miniplayer">Miniplayer</li>
            <li data-action="browser">Browser</li>
            <li data-action="dashboard">Dashboard</li>
            <li data-action="terminal">Terminal</li>
            <li data-action="createfile">Create File</li>
        </ul>
    </div>

    <script>
    document.addEventListener('contextmenu', function(e) {
        e.preventDefault();
        const menu = document.getElementById('customContextMenu');
        menu.style.top = e.clientY + 'px';
        menu.style.left = e.clientX + 'px';
        menu.style.display = 'block';
    });

    document.addEventListener('click', function(e) {
        const menu = document.getElementById('customContextMenu');
        if (menu.style.display === 'block') {
            menu.style.display = 'none';
        }
    });

    document.getElementById('customContextMenu').addEventListener('click', function(e) {
        if (e.target.tagName === 'LI') {
            const action = e.target.getAttribute('data-action');
            if (action === 'miniplayer') {
                window.openApp('miniplayer');
            } else if (action === 'browser') {
                window.openApp('web');
            } else if (action === 'dashboard') {
                window.openApp('dash');
            } else if (action === 'terminal') {
                window.openApp('terminal');
            } else if (action === 'createfile') {
                const fileName = prompt('Enter the name of the new file:');
                if (fileName) {
                    // Assuming root directory 'C:\\' for file creation
                    const result = touch('C:\\', fileName);
                    alert(result);
                    window.location.reload();
                }
            }
            this.style.display = 'none';
        }
    });
    </script>
    <script type="module" src="scripts/js/filesystem.js" defer></script>

    <div id="file-list" style="color: white; padding: 10px; font-family: monospace; white-space: pre-wrap;"></div>

    <style>
      .desktop-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 80px;
        color: white;
        cursor: default;
        user-select: none;
        padding: 5px;
        border-radius: 6px;
        transition: background-color 0.2s ease;
      }
      .desktop-item.selected,
      .desktop-item.highlighted {
        background-color: rgba(74, 144, 226, 0.5);
      }
      #trash-bin {
        width: 80px;
        color: white;
        cursor: pointer;
        user-select: none;
        padding: 5px;
        border-radius: 6px;
        transition: background-color 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #trash-bin img {
        width: 48px;
        height: 48px;
        object-fit: contain;
      }
      #trash-bin.drag-over {
        background-color: rgba(74, 144, 226, 0.5);
      }
    </style>

    <script type="module">
      import { ls, deleteItem, readFile, writeFile } from './scripts/js/filesystem.js';

      const fileListDiv = document.getElementById('file-list');

      // Notepad modal for editing files
      function openNotepad(path, fileName) {
        // Remove any existing modal
        let existing = document.getElementById('notepad-modal');
        if (existing) existing.remove();

        const modal = document.createElement('div');
        modal.id = 'notepad-modal';
        modal.style.position = 'fixed';
        modal.style.top = '50%';
        modal.style.left = '50%';
        modal.style.transform = 'translate(-50%, -50%)';
        modal.style.background = '#222';
        modal.style.color = '#fff';
        modal.style.border = '2px solid #bb86fc';
        modal.style.borderRadius = '10px';
        modal.style.zIndex = 99999;
        modal.style.padding = '24px 18px 12px 18px';
        modal.style.boxShadow = '0 2px 18px 0 #000c, 0 2px 8px 2px #0006';
        modal.style.minWidth = '340px';
        modal.style.maxWidth = '90vw';

        const title = document.createElement('div');
        title.textContent = `Editing: ${fileName}`;
        title.style.fontWeight = 'bold';
        title.style.marginBottom = '10px';
        title.style.fontSize = '1.1em';

        const textarea = document.createElement('textarea');
        textarea.value = readFile(path, fileName);
        textarea.style.width = '100%';
        textarea.style.height = '220px';
        textarea.style.marginBottom = '12px';
        textarea.style.background = '#181818';
        textarea.style.color = '#fff';
        textarea.style.border = '1px solid #444';
        textarea.style.borderRadius = '6px';
        textarea.style.fontFamily = 'monospace';
        textarea.style.fontSize = '1em';
        textarea.style.resize = 'vertical';

        const btnRow = document.createElement('div');
        btnRow.style.textAlign = 'right';
        btnRow.style.marginTop = '6px';

        const saveBtn = document.createElement('button');
        saveBtn.textContent = 'Save';
        saveBtn.style.background = '#bb86fc';
        saveBtn.style.color = '#222';
        saveBtn.style.border = 'none';
        saveBtn.style.borderRadius = '5px';
        saveBtn.style.padding = '7px 22px';
        saveBtn.style.marginRight = '8px';
        saveBtn.style.fontWeight = 'bold';
        saveBtn.style.cursor = 'pointer';

        const cancelBtn = document.createElement('button');
        cancelBtn.textContent = 'Cancel';
        cancelBtn.style.background = '#444';
        cancelBtn.style.color = '#fff';
        cancelBtn.style.border = 'none';
        cancelBtn.style.borderRadius = '5px';
        cancelBtn.style.padding = '7px 16px';
        cancelBtn.style.cursor = 'pointer';

        saveBtn.onclick = () => {
          writeFile(path, fileName, textarea.value);
          modal.remove();
        };
        cancelBtn.onclick = () => modal.remove();

        btnRow.appendChild(saveBtn);
        btnRow.appendChild(cancelBtn);

        modal.appendChild(title);
        modal.appendChild(textarea);
        modal.appendChild(btnRow);

        document.body.appendChild(modal);
      }

      function renderTrashBin() {
        const trashBin = document.createElement('div');
        trashBin.id = 'trash-bin';
        trashBin.setAttribute('draggable', 'false');

        const img = document.createElement('img');
        img.src = 'assets/images/trash.png';
        img.alt = 'Trash Bin';

        const label = document.createElement('span');
        label.textContent = 'Trash';

        trashBin.appendChild(img);
        trashBin.appendChild(label);

        // Drag events for visual feedback
        trashBin.addEventListener('dragover', (e) => {
          e.preventDefault();
          trashBin.classList.add('drag-over');
        });

        trashBin.addEventListener('dragleave', (e) => {
          trashBin.classList.remove('drag-over');
        });

        trashBin.addEventListener('drop', (e) => {
          e.preventDefault();
          trashBin.classList.remove('drag-over');
          const data = e.dataTransfer.getData('text/plain');
          if (!data) return;
          try {
            const { name, isFolder } = JSON.parse(data);
            // Delete the item from root directory (C:\)
            const result = deleteItem('C:\\', name);
            console.log(result);
            renderFileSystem('C:\\');
; 
          } catch (err) {
            console.error('Failed to parse drag data', err);
          }
        });

        return trashBin;
      }

      function renderFileSystem(path) {
        const rawList = ls(path);
        if (typeof rawList !== 'string') {
          fileListDiv.textContent = 'Failed to load directory contents.';
          return;
        }
        const entries = rawList.split('\n').filter(e => e.trim().length > 0);
        fileListDiv.innerHTML = '';
        fileListDiv.style.display = 'flex';
        fileListDiv.style.flexWrap = 'wrap';
        fileListDiv.style.gap = '15px';

        // Insert trash bin as first item
        const trashBin = renderTrashBin();
        fileListDiv.appendChild(trashBin);

        entries.forEach(entry => {
          const isFolder = entry.endsWith('\\');
          const name = isFolder ? entry.slice(0, -1) : entry;
          const itemDiv = document.createElement('div');
          itemDiv.classList.add('desktop-item');
          itemDiv.setAttribute('draggable', 'true');
          itemDiv.dataset.name = name;
          itemDiv.dataset.isFolder = isFolder;

          const img = document.createElement('img');
          img.src = isFolder ? 'assets/images/folder.png' : 'assets/images/document.png';
          img.alt = isFolder ? 'Folder' : 'File';
          img.style.width = '48px';
          if (isFolder == 0){
                      // edit the settings to make it a bit ligheter
          img.style.filter = 'brightness(1.5)';
          }
          img.style.height = '48px';
          img.style.objectFit = 'contain';

          const label = document.createElement('span');
          label.textContent = name;
          label.style.marginTop = '5px';
          label.style.textAlign = 'center';
          label.style.wordBreak = 'break-word';
          label.style.fontSize = '14px';

          itemDiv.appendChild(img);
          itemDiv.appendChild(label);
          fileListDiv.appendChild(itemDiv);

          // Click handler to toggle selection
          itemDiv.addEventListener('click', (e) => {
            e.stopPropagation();
            if (itemDiv.classList.contains('selected')) {
              itemDiv.classList.remove('selected');
            } else {
              // If Ctrl or Cmd key is not pressed, clear other selections
              if (!e.ctrlKey && !e.metaKey) {
                clearAllSelections();
              }
              itemDiv.classList.add('selected');
            }
          });

          // Double-click to open notepad editor for files, or edit/run for .js files
          itemDiv.addEventListener('dblclick', (e) => {
            if (isFolder) return;
            if (name.endsWith('.js')) {
              // Custom prompt for JS files
              const modal = document.createElement('div');
              modal.id = 'js-action-modal';
              modal.style.position = 'fixed';
              modal.style.top = '50%';
              modal.style.left = '50%';
              modal.style.transform = 'translate(-50%, -50%)';
              modal.style.background = '#222';
              modal.style.color = '#fff';
              modal.style.border = '2px solid #bb86fc';
              modal.style.borderRadius = '10px';
              modal.style.zIndex = 100000;
              modal.style.padding = '28px 18px 18px 18px';
              modal.style.boxShadow = '0 2px 18px 0 #000c, 0 2px 8px 2px #0006';
              modal.style.minWidth = '260px';
              modal.style.maxWidth = '95vw';
              modal.innerHTML = `
                <div style="font-weight:bold;font-size:1.07em;margin-bottom:10px;">${name}</div>
                <div style="margin-bottom:18px;">What do you want to do?</div>
                <div style="display:flex;gap:10px;justify-content:flex-end;">
                  <button id="js-edit-btn" style="background:#bb86fc;color:#222;border:none;border-radius:5px;padding:8px 20px;font-weight:bold;cursor:pointer;">Edit</button>
                  <button id="js-run-safe-btn" style="background:#1e9c4b;color:#fff;border:none;border-radius:5px;padding:8px 20px;font-weight:bold;cursor:pointer;">Run as User</button>
                  <button id="js-run-admin-btn" style="background:#bb2c2c;color:#fff;border:none;border-radius:5px;padding:8px 20px;font-weight:bold;cursor:pointer;">Run as Admin</button>
                  <button id="js-cancel-btn" style="background:#444;color:#fff;border:none;border-radius:5px;padding:8px 16px;cursor:pointer;">Cancel</button>
                </div>
                <div style="margin-top:10px;font-size:0.93em;color:#aaa;">
                  <b>Run as User:</b> Blocks fetch, XMLHttpRequest, location, and some globals.<br>
                  <b>Run as Admin:</b> Full JS access (no restrictions).
                </div>
              `;
              document.body.appendChild(modal);
              document.getElementById('js-edit-btn').onclick = () => {
                modal.remove();
                openNotepad('C:\\', name);
              };
              document.getElementById('js-run-safe-btn').onclick = () => {
                modal.remove();
                try {
                  // Safe "sandbox" via Function with dangerous APIs blocked
                  const code = readFile('C:\\', name);
                  const sandbox = {
                    fetch: () => { throw new Error("fetch is blocked in User mode."); },
                    XMLHttpRequest: function() { throw new Error("XMLHttpRequest is blocked in User mode."); },
                    WebSocket: function() { throw new Error("WebSocket is blocked in User mode."); },
                    location: undefined,
                    document: undefined,
                    window: undefined,
                    localStorage: undefined,
                    sessionStorage: undefined,
                    indexedDB: undefined,
                    eval: undefined,
                    Function: undefined,
                    require: undefined,
                    importScripts: undefined,
                  };
                  // Provide a minimal set of safe globals (console, Math, Date, etc.)
                  const safeGlobals = { console, Math, Date, setTimeout, setInterval, clearTimeout, clearInterval };
                  const func = new Function(
                    ...Object.keys(safeGlobals).concat(Object.keys(sandbox)),
                    `"use strict";\n${code}`
                  );
                  func(...Object.values(safeGlobals), ...Object.values(sandbox));
                } catch (err) {
                  alert('Error running JS file (User mode):\\n' + err);
                }
              };
              document.getElementById('js-run-admin-btn').onclick = () => {
                modal.remove();
                try {
                  // eslint-disable-next-line no-eval
                  eval(readFile('C:\\', name));
                } catch (err) {
                  alert('Error running JS file (Admin mode):\\n' + err);
                }
              };
              document.getElementById('js-cancel-btn').onclick = () => {
                modal.remove();
              };
            } else {
              openNotepad('C:\\', name);
            }
          });

          // Drag start handler to set drag data
          itemDiv.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('text/plain', JSON.stringify({
              name: name,
              isFolder: isFolder
            }));
            // Optionally, set drag image
            // e.dataTransfer.setDragImage(itemDiv, 10, 10);
          });
        });
      }

      function clearAllSelections() {
        document.querySelectorAll('.desktop-item.selected').forEach(el => {
          el.classList.remove('selected');
        });
        document.querySelectorAll('.desktop-item.highlighted').forEach(el => {
          el.classList.remove('highlighted');
        });
      }

      // Clear selection when clicking outside any desktop item
      document.addEventListener('click', () => {
        clearAllSelections();
      });

      // Extend selection box logic to select intersecting items and highlight during drag
      (function() {
        const selectionBox = document.getElementById('selectionBox');
        let startX, startY, currentX, currentY;
        let isSelecting = false;

        function updateSelectionBox() {
          const x = Math.min(startX, currentX);
          const y = Math.min(startY, currentY);
          const width = Math.abs(startX - currentX);
          const height = Math.abs(startY - currentY);
          selectionBox.style.left = x + 'px';
          selectionBox.style.top = y + 'px';
          selectionBox.style.width = width + 'px';
          selectionBox.style.height = height + 'px';
        }

        function rectsIntersect(r1, r2) {
          return !(r2.left > r1.right ||
                   r2.right < r1.left ||
                   r2.top > r1.bottom ||
                   r2.bottom < r1.top);
        }

        document.addEventListener('mousedown', function(e) {
          if (e.button !== 0) return;
          isSelecting = true;
          startX = e.clientX;
          startY = e.clientY;
          currentX = startX;
          currentY = startY;
          updateSelectionBox();
          selectionBox.style.display = 'block';

          // Clear previous selections on new drag unless Ctrl/Cmd is pressed
          if (!e.ctrlKey && !e.metaKey) {
            clearAllSelections();
          }
        });

        document.addEventListener('mousemove', function(e) {
          if (!isSelecting) return;
          currentX = e.clientX;
          currentY = e.clientY;
          updateSelectionBox();

          const selectionRect = selectionBox.getBoundingClientRect();
          document.querySelectorAll('.desktop-item').forEach(item => {
            const itemRect = item.getBoundingClientRect();
            if (rectsIntersect(selectionRect, itemRect)) {
              item.classList.add('highlighted');
            } else {
              item.classList.remove('highlighted');
            }
          });
        });

        document.addEventListener('mouseup', function(e) {
          if (!isSelecting) return;
          isSelecting = false;
          selectionBox.style.display = 'none';

          const selectionRect = selectionBox.getBoundingClientRect();
          document.querySelectorAll('.desktop-item').forEach(item => {
            const itemRect = item.getBoundingClientRect();
            if (rectsIntersect(selectionRect, itemRect)) {
              item.classList.add('selected');
              item.classList.remove('highlighted');
            } else {
              item.classList.remove('highlighted');
            }
          });
        });
      })();



      renderFileSystem('C:\\');

      // Re-render when the FS changes (same tab)
      window.addEventListener('fschange', () => {
        renderFileSystem('C:\\');
      });

      // Re-render when FS changes in another tab
      window.addEventListener('storage', (e) => {
        if (e.key === 'emulatedFileSystemWin') {
          renderFileSystem('C:\\');
        }
      });

// Wallpaper sync only
(function() {
    function applyWallpaper() {
        var wallpaper = localStorage.getItem('wallpaper') || 'assets/images/wallpaper.webp';
        if (wallpaper) {
            document.body.style.backgroundImage = 'url(' + wallpaper + ')';
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundRepeat = 'no-repeat';
            document.body.style.backgroundColor = '#222';
        }
    }
    applyWallpaper();
    window.addEventListener('storage', function(e) {
        if (e.key === 'wallpaper') {
            applyWallpaper();
        }
    });
})();
</script>
<script>
(function() {
  let overlay = null;
  let panicActive = false;

  function showPanicOverlay(imgUrl) {
    if (panicActive) return;
    panicActive = true;
    overlay = document.createElement('div');
    overlay.id = 'panic-image-overlay';
    Object.assign(overlay.style, {
      position: 'fixed',
      top: 0,
      left: 0,
      width: '100vw',
      height: '100vh',
      background: '#111 center center/contain no-repeat',
      backgroundImage: `url('${imgUrl}')`,
      zIndex: 2147483647,
      display: 'flex',
      alignItems: 'center',
      justifyContent: 'center',
      pointerEvents: 'auto'
    });
    overlay.tabIndex = -1;
    document.body.appendChild(overlay);
    overlay.focus();
  }

  function hidePanicOverlay() {
    if (overlay && panicActive) {
      overlay.remove();
      overlay = null;
      panicActive = false;
    }
  }

  document.addEventListener('keydown', function(e) {
    // If overlay is active, only listen for exit key
    if (panicActive) {
      const exitKey = localStorage.getItem('panic_exit_key') || '';
      if (exitKey && e.key.toLowerCase() === exitKey.toLowerCase()) {
        hidePanicOverlay();
        e.preventDefault();
      }
      return;
    }
    // If not active, listen for panic key
    const panicKey = localStorage.getItem('panic_key') || '';
    const panicImage = localStorage.getItem('panic_image') || '';
    if (
      panicKey &&
      e.key.toLowerCase() === panicKey.toLowerCase() &&
      panicImage
    ) {
      showPanicOverlay(panicImage);
      e.preventDefault();
    }
  });
})();
</script>
</body>
</html>
